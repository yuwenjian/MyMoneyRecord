# 📊 上证指数自动填充功能

## 功能说明

当用户在记录页面填写数据时，如果数据库中已有当天日期的上证指数数据，系统会自动填充到"上证指数"输入框。

## 实现逻辑

### 触发时机

在以下情况下会自动检查并填充上证指数：

1. **页面初次加载**时
2. **日期改变**时（通过 `useEffect` 监听 `formData.date`）

### 数据来源

```javascript
// 获取当天的所有记录
const todayRecords = sortedRecords.filter(r => r.date === today)

// 查找任意一条有上证指数的记录
const todayWithShanghaiIndex = todayRecords.find(r => r.shanghaiIndex)

// 如果找到，自动填充
if (todayWithShanghaiIndex && todayWithShanghaiIndex.shanghaiIndex) {
  setFormData(prev => ({
    ...prev,
    shanghaiIndex: todayWithShanghaiIndex.shanghaiIndex.toString()
  }))
}
```

## 使用场景

### 场景1：同一天记录多个类型

```
2025-12-25 的数据：
- 股票记录：总资产 168,850.80, 总市值 42,047.00, 上证指数 3917.36
- 基金记录：总资产 128,810.18

当用户添加第二条基金记录时：
→ 自动填充上证指数：3917.36 ✅
```

### 场景2：同一天重复记录

```
已有记录：
- 2025-12-25 上午：上证指数 3917.36

再次添加记录：
- 2025-12-25 下午：上证指数自动填充为 3917.36 ✅
```

### 场景3：历史日期补录

```
选择日期：2025-12-20

如果该日期已有记录包含上证指数：
→ 自动填充 ✅

如果该日期没有记录：
→ 需要手动输入或OCR识别
```

## 代码实现

### 在 RecordPage.jsx 中

```javascript
// 加载今日概览数据
const loadTodayOverview = async () => {
  try {
    const records = await getRecords()
    // ...
    
    const today = dayjs().format('YYYY-MM-DD')
    const todayRecords = sortedRecords.filter(r => r.date === today)
    
    // 🆕 自动填充今日上证指数（如果已有记录）
    const todayWithShanghaiIndex = todayRecords.find(r => r.shanghaiIndex)
    if (todayWithShanghaiIndex && todayWithShanghaiIndex.shanghaiIndex) {
      setFormData(prev => ({
        ...prev,
        shanghaiIndex: todayWithShanghaiIndex.shanghaiIndex.toString()
      }))
      console.log('✅ 自动填充今日上证指数:', todayWithShanghaiIndex.shanghaiIndex)
    }
    
    // ...
  } catch (error) {
    console.error('加载今日概览失败:', error)
  }
}
```

### useEffect 监听

```javascript
// 当日期改变时，重新加载概览数据（包括自动填充上证指数）
useEffect(() => {
  loadTodayOverview()
}, [formData.date])
```

## 用户体验

### 优点

1. **避免重复输入**
   - 同一天多次记录，只需输入一次上证指数

2. **数据一致性**
   - 同一天的所有记录使用相同的上证指数

3. **提高效率**
   - 减少手动输入，自动填充常用数据

### 注意事项

1. **可以修改**
   - 自动填充的值可以被用户手动修改

2. **优先级**
   - OCR识别 > 自动填充 > 手动输入
   - 如果OCR识别到新的上证指数，会覆盖自动填充的值

3. **数据来源**
   - 取第一条有上证指数的记录（股票或基金）

## 控制台日志

### 成功填充

```
✅ 自动填充今日上证指数: 3917.36
```

### 无数据可填充

```
（无日志，表单保持空白）
```

## 数据流程

```
页面加载
    ↓
loadTodayOverview()
    ↓
获取今日所有记录
    ↓
查找有上证指数的记录
    ↓
找到了？
    ├─ Yes → 自动填充到表单 ✅
    └─ No  → 表单保持空白
```

## 优先级规则

当多种数据源同时存在时，优先级如下：

```
1. 用户手动输入（最高）
   - 用户在输入框中修改

2. OCR识别
   - 上传图片识别到的上证指数

3. 自动填充（最低）
   - 从数据库加载的历史值
```

## 示例

### 示例1：首次记录

```
日期：2025-12-25
投资类型：股票
总资产：168,850.80
总市值：42,047.00
上证指数：3917.36  ← 手动输入或OCR识别

保存后 → 数据库：
{
  date: "2025-12-25",
  investmentType: "stock",
  totalAsset: 168850.80,
  totalMarketValue: 42047.00,
  shanghaiIndex: 3917.36  ← 保存
}
```

### 示例2：当天第二次记录

```
日期：2025-12-25（默认今天）
投资类型：基金

页面加载 →
  查询数据库 →
  发现2025-12-25已有记录，上证指数为 3917.36 →
  自动填充 ✅

表单显示：
上证指数：3917.36  ← 自动填充，无需手动输入
```

### 示例3：补录历史数据

```
选择日期：2025-12-20

查询数据库 →
  2025-12-20 有记录吗？
    ├─ Yes，且有上证指数 → 自动填充 ✅
    └─ No → 需要手动输入
```

## 技术细节

### 数据查询

```javascript
// 过滤当天的记录
const todayRecords = sortedRecords.filter(r => r.date === today)

// 查找第一条有上证指数的记录
const todayWithShanghaiIndex = todayRecords.find(r => r.shanghaiIndex)

// find() 会返回第一个匹配的记录
// 不管是股票还是基金，只要有上证指数就用
```

### 数据类型转换

```javascript
// 数据库中是数字，需要转换为字符串填入表单
shanghaiIndex: todayWithShanghaiIndex.shanghaiIndex.toString()
```

### 状态更新

```javascript
// 使用函数式更新，确保不覆盖其他表单字段
setFormData(prev => ({
  ...prev,  // 保留原有数据
  shanghaiIndex: value  // 只更新上证指数
}))
```

## 测试方法

### 测试步骤

1. **添加第一条记录**
   ```
   日期：今天
   类型：股票
   上证指数：3917.36
   保存
   ```

2. **返回记录页面**
   ```
   刷新页面或重新进入
   ```

3. **查看上证指数输入框**
   ```
   应该自动显示：3917.36 ✅
   ```

4. **选择其他日期**
   ```
   选择明天或昨天
   → 上证指数应该清空（因为没有数据）
   ```

5. **再次选择今天**
   ```
   → 上证指数重新自动填充：3917.36 ✅
   ```

## 扩展可能

### 未来可以扩展的功能

1. **记忆最近的上证指数**
   - 如果当天没有，使用最近一天的数据

2. **根据时间智能填充**
   - 工作日：自动获取当天指数
   - 周末：使用上周五的指数

3. **提示用户**
   - 显示"上证指数已自动填充"提示
   - 显示数据来源时间

---

## 📊 功能已完成

**核心功能：**
- ✅ 自动检测当天日期是否有上证指数数据
- ✅ 有数据时自动填充到表单
- ✅ 日期改变时重新检查
- ✅ 详细的控制台日志

**用户体验：**
- ✅ 同一天多次记录，无需重复输入上证指数
- ✅ 数据一致性
- ✅ 可手动修改自动填充的值

---

**🎉 功能已上线！请刷新页面测试！**

