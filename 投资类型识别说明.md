# 📊 投资类型识别说明

## 功能概述

系统现在支持根据投资类型（股票/基金）使用不同的OCR识别逻辑。

## 识别模式对比

### 🎯 股票模式（当前使用）

**关键词匹配：**
- **总资产**：`总资产`、`账户总资产`、`资产总额`
- **总市值**：`总市值`、`持有市值`、`市值`
- **上证指数**：`上证指数`、`沪指`、`上证`

**排除关键词：**
- `盈亏`、`盈利`、`亏损`、`收益`、`利润`
- `参考盈亏`、`当日盈亏`、`累计盈亏`
- `持有收益`、`日收益`

**验证规则：**
- 总资产 ≥ 1,000元
- 总市值范围：总资产的 10%-95%
- 市值不能超过总资产的110%
- 排除6位整数（股票代码）

**适用截图：**
```
┌─────────────────────────┐
│ 股票资产(元)             │
│ 国金证券(888****3495)    │
│                         │
│ 168,850.80             │ ← 总资产
│                         │
│ 持有市值                 │
│ 42,047.00              │ ← 总市值
│                         │
│ 浮动盈亏                 │
│ +31,842.59             │ ← 会被排除
└─────────────────────────┘
```

---

### 💰 基金模式（新增）

**关键词匹配：**
- **总资产**：`总资产`、`账户总资产`、`资产总额`、`基金资产`、`基金总额`、`总金额`
- **持有收益**：`持有收益`、`累计收益`、`持有.*收益`、`总收益`
- **上证指数**：`上证指数`、`沪指`、`上证`（可选）

**排除关键词（较宽松）：**
- `参考盈亏`、`当日盈亏`、`日收益`

**验证规则：**
- 总资产 ≥ 1,000元
- **持有收益可以是负数**（与股票不同）
- 持有收益不受比例限制
- 持有收益 < 总资产即可

**适用截图：**
```
┌─────────────────────────┐
│ 基金资产(元)             │
│ 支付宝                  │
│                         │
│ 128,810.18             │ ← 总资产（基金总额）
│                         │
│ 持有收益                 │
│ +21,579.33             │ ← 持有收益（代替市值）
│                         │
│ 日收益(12-22)           │
│ +1,413.48              │ ← 会被排除
└─────────────────────────┘
```

## 使用方法

### 当前实现状态

代码已经准备好支持基金模式，关键函数：

```javascript
// src/utils/ocr.js

// 已实现：根据投资类型使用不同模式
const parseTonghuashunData = (text, investmentType = 'stock') => {
  const patterns = investmentType === 'stock' 
    ? getStockPatterns()      // 股票模式
    : getFundPatterns()        // 基金模式
  
  return parseWithPatterns(text, lines, patterns, result)
}

// 批量识别时传入投资类型
export const recognizeMultipleImages = async (images, investmentType = 'stock') => {
  // ...
  const parsedData = parseTonghuashunData(text, investmentType)
  // ...
}
```

### 前端调用

在 `RecordPage.jsx` 中，已经正确传递了投资类型：

```javascript
// 第167行
const result = await recognizeMultipleImages(uploadedImages, formData.investmentType)
```

这意味着：
- ✅ 选择"股票"类型上传图片 → 使用股票识别逻辑
- ✅ 选择"基金"类型上传图片 → 使用基金识别逻辑

## 识别字段对比

| 字段 | 股票模式 | 基金模式 |
|------|---------|---------|
| 总资产 | ✅ 识别 | ✅ 识别 |
| 总市值 | ✅ 识别（10%-95%） | ❌ 不识别 |
| 持有收益 | ❌ 排除 | ✅ 识别（可负数）|
| 上证指数 | ✅ 识别 | ⚠️ 可选 |
| 盈亏数据 | ❌ 严格排除 | ⚠️ 宽松排除 |

## 基金模式特点

### 1. 更宽松的关键词匹配

```javascript
// 基金资产的多种叫法
totalAsset: /总资产|账户总资产|资产总额|基金资产|基金总额|总金额/i
```

### 2. 持有收益可以是负数

```javascript
// 基金模式下，"持有收益"代替"总市值"
// 允许负数（股票跌了，收益为负）
totalMarketValue: /持有收益|累计收益|持有.*收益|总收益/i

// 合并时选择第一个有效值（不是最大值）
if (investmentType === 'fund') {
  merged.totalMarketValue = holdingProfits[0]  // 第一个（可能是负数）
}
```

### 3. 较少的排除项

```javascript
// 基金模式排除项较少
excludeKeywords: /参考盈亏|当日.*盈亏|日收益/i

// "持有收益"、"累计收益" 不会被排除
```

## 测试用例

### 股票模式测试

**输入图片：**
- 同花顺股票资产页截图
- 包含：总资产 168,850.80、总市值 42,047.00

**预期输出：**
```javascript
{
  totalAsset: 168850.8,
  totalMarketValue: 42047,
  shanghaiIndex: 3917.36
}
```

### 基金模式测试

**输入图片：**
- 支付宝基金资产页截图
- 包含：基金总额 128,810.18、持有收益 +21,579.33

**预期输出：**
```javascript
{
  totalAsset: 128810.18,
  totalMarketValue: 21579.33,  // 持有收益
  shanghaiIndex: null
}
```

## 使用流程

### 用户操作

1. **选择投资类型**：
   - 点击"股票"或"基金"按钮

2. **上传图片**：
   - 上传对应类型的截图

3. **点击识别**：
   - 系统自动使用对应的识别逻辑

4. **查看结果**：
   - 股票：自动填入"总资产"和"总市值"
   - 基金：自动填入"总资产"和"持有收益"（显示为"总市值"字段）

### 注意事项

1. **先选择类型再上传图片**：
   - 系统根据当前选择的类型进行识别

2. **图片内容要匹配类型**：
   - 选择"股票"，请上传股票资产截图
   - 选择"基金"，请上传基金资产截图

3. **字段含义不同**：
   - 股票的"总市值"= 持仓市值
   - 基金的"总市值"= 持有收益（可能是负数）

## 技术实现

### 核心函数

1. **`getStockPatterns()`** - 股票关键词模式
2. **`getFundPatterns()`** - 基金关键词模式
3. **`parseWithPatterns()`** - 通用解析逻辑
4. **`mergeRecognitionResults()`** - 支持不同模式的结果合并

### 扩展性

如果未来需要添加其他类型（如期货、债券），只需：

1. 创建新的模式函数：`getFuturesPatterns()`
2. 在 `parseTonghuashunData` 中添加条件分支
3. 更新前端类型选择UI

---

## 当前状态

✅ **已完成**：
- 股票模式识别逻辑
- 基金模式识别逻辑
- 前端类型传递
- 结果合并逻辑

✅ **可直接使用**：
- 选择"股票"→ 上传股票截图 → 正常识别
- 选择"基金"→ 上传基金截图 → 使用基金逻辑识别

🔄 **下一步优化**：
- 根据实际基金截图调整关键词
- 优化基金模式的数字验证规则
- 添加更详细的基金识别日志

---

**💡 提示：** 
如果您有支付宝或天天基金的截图，可以上传测试基金模式的识别效果！

