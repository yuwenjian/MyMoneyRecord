# 🚨 紧急修复：股票代码误识别问题

## 问题现象

**用户反馈：**
- 应该识别：总资产 168,850.80，总市值 42,047.00
- 实际识别：总资产 603803，总市值 513100

## 根本原因

**致命缺陷：系统把股票代码当成了金额！**

```
同花顺截图包含：
- 瑞斯康达 603803  ← 股票代码被识别成总资产！
- 纳指ETF 513100   ← 基金代码被识别成总市值！
- 真实数据被忽略！
```

## 核心修复

### 1. 股票代码检测与过滤

```javascript
// 检测6位纯数字（A股代码格式）
const isStockCode = /^[0-9]{6}$/.test(cleaned.trim())
if (isStockCode) {
  console.log(`[过滤] "${text}" → 股票代码，跳过`)
  return null
}

// 检测基金代码（5-6位数字+字母）
const isFundCode = /^[0-9]{5,6}[A-Z]*$/.test(cleaned.trim())
if (isFundCode) {
  console.log(`[过滤] "${text}" → 基金代码，跳过`)
  return null
}
```

### 2. 优先识别千分位格式

```javascript
// 优先匹配带千分位的金额（如 168,850.80）
const commaNumberMatch = originalText.match(/(\d{1,3}(?:,\d{3})+\.?\d*)/)
if (commaNumberMatch) {
  const num = parseFloat(commaNumberMatch[1].replace(/,/g, ''))
  console.log(`[提取] "${text}" → ${num} (千分位格式) ✓`)
  return num
}
```

### 3. 上下文行过滤

```javascript
// 排除包含股票代码的整行
const isStockLine = lineUpper.includes('603803') || 
                   lineUpper.includes('603267') || 
                   lineUpper.includes('513100') ||
                   /\d{6}\s*融/.test(line)  // 如 "603803 融"

if (!isStockLine) {
  allNumbers.push({ value: num, line: line.trim() })
} else {
  console.log(`[过滤股票行] ${line.trim()}`)
}
```

### 4. 候选数字二次过滤

```javascript
// 在选择候选总资产时，再次排除6位整数
.filter(n => {
  if (n.value >= 100000 && n.value < 1000000 && Number.isInteger(n.value)) {
    console.log(`[候选过滤] ${n.value} 疑似股票代码`)
    return false
  }
  return true
})
```

## 修复对比

### 修复前的逻辑

```javascript
// ❌ 问题：没有检查是否是股票代码
const matches = cleaned.match(/-?\d+\.?\d*/g)
const maxNum = Math.max(...numbers)  // 603803 > 168850.80，被错误选中！
return maxNum
```

### 修复后的逻辑

```javascript
// ✅ 多层防护
1. 检测6位纯数字格式 → 直接返回null
2. 优先匹配千分位格式 → 168,850.80 优先级最高
3. 过滤疑似股票代码行 → 跳过"瑞斯康达 603803"
4. 候选池二次过滤 → 排除所有6位整数
5. 范围验证 → 总资产必须≥1000元
```

## 识别优先级

### 新的识别顺序（从高到低）

```
1. 带千分位的金额       168,850.80  ← 最高优先级 ✓
2. 大额小数（≥100）      168850.80   ← 高优先级 ✓
3. 普通小数               42047.00   ← 中优先级 ✓
4. 纯整数且<6位           12345      ← 低优先级
-----------------------------------------
❌ 6位纯整数             603803     ← 直接排除（股票代码）
❌ 5-6位+字母            513100T    ← 直接排除（基金代码）
```

## 过滤规则汇总

| 格式 | 示例 | 判定 | 原因 |
|------|------|------|------|
| 6位纯整数 | 603803 | ❌ 排除 | A股代码 |
| 6位纯整数 | 513100 | ❌ 排除 | ETF代码 |
| 5位纯整数 | 51310 | ⚠️ 警告 | 疑似代码 |
| 千分位金额 | 168,850.80 | ✅ 最优 | 标准金额 |
| 大额小数 | 168850.80 | ✅ 优先 | 真实金额 |
| 小额小数 | 42047.00 | ✅ 接受 | 真实金额 |
| 7位整数 | 1688508 | ✅ 接受 | 超过6位 |

## 测试验证

### 测试案例1：同花顺持仓页

**输入：**
```
瑞斯康达
603803 融
12.12  +4.94%  0.57

鸿远电子  
603267 融
48.99  +1.07%  0.52
```

**预期：**
- ❌ 不识别 603803（股票代码）
- ❌ 不识别 603267（股票代码）
- ✅ 可识别 12.12, 48.99（价格）

### 测试案例2：同花顺资产页

**输入：**
```
总资产 👁
168,850.80

总市值
42,047.00
```

**预期：**
- ✅ 识别 168850.80（千分位优先）
- ✅ 识别 42047.00（小数格式）

### 测试案例3：混合场景

**输入：**
```
纳指ETF
513100
1.945  +1.51%

总资产
168,850.80
```

**预期：**
- ❌ 不识别 513100（基金代码）
- ✅ 识别 1.945（ETF价格）
- ✅ 识别 168850.80（总资产）

## 调试信息示例

刷新页面后，控制台会显示：

```
======== 开始解析同花顺数据 ========
行3: 603803 融
  [过滤] "603803" → 股票代码，跳过
  [过滤股票行] 603803 融

行7: 513100 T+0
  [过滤] "513100" → 基金代码，跳过
  [过滤股票行] 513100 T+0

行15: 总资产 👁
  → 发现总资产关键词行
行16: 168,850.80
  [提取] "168,850.80" → 168850.8 (千分位格式) ✓
  ✓ 成功识别总资产: 168850.8

行18: 总市值
  → 发现市值关键词行
行19: 42,047.00
  [提取] "42,047.00" → 42047 (千分位格式) ✓
  ✓ 成功识别总市值: 42047

======== 最终解析结果 ========
总资产: 168850.8
总市值: 42047
上证指数: 3917.36
============================
```

## 立即测试

1. **刷新页面**（Ctrl/Cmd + R）
2. **清除旧图**：点击"清除全部"
3. **重新上传**：选择同花顺截图
4. **点击识别**：查看新结果
5. **查看日志**：按F12看详细过程

## 保证

✅ **603803** → 不会被识别为总资产  
✅ **513100** → 不会被识别为总市值  
✅ **168,850.80** → 正确识别为总资产  
✅ **42,047.00** → 正确识别为总市值  

---

**🔥 紧急修复已完成，请立即刷新测试！**

