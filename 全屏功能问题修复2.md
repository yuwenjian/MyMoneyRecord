# 🐛 全屏功能问题修复（第二次）

## 问题描述

用户反馈了两个新的问题：

1. **❌ 图表全屏后 X 轴日期仍然不显示**
   - 虽然修复了颜色，但日期标签还是看不见
   
2. **❌ 点击历史记录的放大按钮时显示折线图**
   - 应该显示表格的全屏视图
   - 但却显示了图表

## 问题原因分析

### 问题 1：X 轴日期不显示

**深层原因：**

虽然我们设置了颜色，但可能还有其他问题：

1. **标签旋转问题：**
   ```javascript
   ticks: {
     color: '#333333',
     // ❌ 缺少旋转设置，标签可能重叠
   }
   ```

2. **Chart.js 渲染时机：**
   - 全屏状态改变时，图表可能没有立即重新渲染
   - 需要强制刷新布局

### 问题 2：历史记录放大按钮冲突

**根本原因：**

图表全屏和表格全屏共用了同一个状态！

```javascript
// ❌ 问题代码
const [isFullScreen, setIsFullScreen] = useState(false)

// 图表全屏按钮
<button onClick={toggleFullScreen}>⛶</button>

// 表格全屏按钮
<button onClick={() => setIsFullScreen(true)}>⛶</button>

// 两个功能冲突！
```

**导致的问题：**
- 点击表格放大按钮 → `setIsFullScreen(true)`
- 触发图表的全屏容器显示 → 显示图表而不是表格
- 因为图表容器的 class 是 `${isFullScreen ? 'fullscreen' : ''}`

## 解决方案

### 修复 1：分离全屏状态

**创建两个独立的状态：**

```javascript
// ✅ 修复后
const [isChartFullScreen, setIsChartFullScreen] = useState(false)  // 图表全屏
const [isTableFullScreen, setIsTableFullScreen] = useState(false)  // 表格全屏
```

**更新所有相关代码：**

1. **全屏状态监听：**
```javascript
useEffect(() => {
  const handleFullScreenChange = () => {
    const isInFullScreen = !!document.fullscreenElement
    setIsChartFullScreen(isInFullScreen)  // ✅ 使用图表状态
  }
  // ...
}, [])
```

2. **图表容器：**
```javascript
<div className={`chart-container ${isChartFullScreen ? 'fullscreen' : ''}`}>
  {/* 图表内容 */}
</div>
```

3. **图表配置：**
```javascript
const chartOptions = {
  plugins: {
    legend: {
      labels: {
        color: isChartFullScreen ? '#333333' : undefined,
      }
    }
  },
  scales: {
    x: {
      ticks: {
        color: isChartFullScreen ? '#333333' : undefined,
      }
    }
  }
}
```

4. **表格全屏按钮：**
```javascript
<button onClick={() => setIsTableFullScreen(true)}>⛶</button>
```

5. **表格全屏弹出层：**
```javascript
{isTableFullScreen && (
  <div className="fullscreen-overlay">
    {/* 表格内容 */}
  </div>
)}
```

### 修复 2：优化 X 轴标签显示

**添加标签旋转配置：**

```javascript
scales: {
  x: {
    ticks: {
      color: isChartFullScreen ? '#333333' : undefined,
      maxRotation: 45,    // ✅ 最大旋转45度
      minRotation: 0,     // ✅ 最小不旋转
      autoSkip: true,     // ✅ 自动跳过重叠标签（Chart.js 默认）
    }
  }
}
```

**为什么需要旋转？**
- X 轴日期标签可能很长（如 "2025-12-22"）
- 如果标签太多会重叠
- 旋转可以让更多标签显示

## 修复效果

### 修复前

**图表全屏：**
```
问题1: X 轴日期不显示 ❌
问题2: （还未发现）
```

**点击表格放大：**
```
期望: 显示表格全屏 ✅
实际: 显示图表全屏 ❌
```

### 修复后

**图表全屏：**
```
✅ X 轴日期清晰显示
✅ 标签自动旋转避免重叠
✅ 全屏功能正常
```

**点击表格放大：**
```
✅ 显示表格全屏弹出层
✅ 不影响图表
✅ 功能独立工作
```

## 状态管理对比

### 修复前（共用状态）

```javascript
// ❌ 一个状态管理两个功能
const [isFullScreen, setIsFullScreen] = useState(false)

// 图表全屏
<div className={isFullScreen ? 'fullscreen' : ''}>图表</div>

// 表格全屏  
{isFullScreen && <div>表格弹出层</div>}

// 问题：状态冲突！
```

**冲突场景：**
```
1. 用户点击表格放大按钮
   → setIsFullScreen(true)
   
2. 触发两个条件同时满足：
   - 图表容器 class='fullscreen' ✅
   - 表格弹出层显示 ✅
   
3. 结果：图表全屏了，但用户想看表格 ❌
```

### 修复后（独立状态）

```javascript
// ✅ 两个独立状态
const [isChartFullScreen, setIsChartFullScreen] = useState(false)
const [isTableFullScreen, setIsTableFullScreen] = useState(false)

// 图表全屏
<div className={isChartFullScreen ? 'fullscreen' : ''}>图表</div>

// 表格全屏
{isTableFullScreen && <div>表格弹出层</div>}

// 完全独立，互不影响！
```

**正确流程：**
```
场景1：用户点击图表放大
→ toggleFullScreen()
→ setIsChartFullScreen(true)
→ 图表全屏显示 ✅
→ 表格不受影响 ✅

场景2：用户点击表格放大
→ setIsTableFullScreen(true)
→ 表格弹出层显示 ✅
→ 图表不受影响 ✅
```

## X 轴标签优化详解

### 标签旋转

**配置选项：**
```javascript
ticks: {
  maxRotation: 45,    // 最大旋转角度
  minRotation: 0,     // 最小旋转角度
  autoSkip: true,     // 自动跳过重叠标签
}
```

**效果展示：**

**minRotation: 0**
```
2025-12-22  2025-12-23  2025-12-24
```

**maxRotation: 45**
```
    2025-12-24
  2025-12-23
2025-12-22
```

**优势：**
- ✅ 更多标签可以显示
- ✅ 避免文字重叠
- ✅ 保持可读性

### autoSkip 自动跳过

Chart.js 默认启用 `autoSkip: true`

**行为：**
- 当标签太密集时，自动跳过一些标签
- 确保显示的标签不会重叠

**示例：**
```
// 原始数据：10个日期
2025-12-15, 2025-12-16, 2025-12-17, ...

// autoSkip 后可能显示
2025-12-15, 2025-12-17, 2025-12-19, ...
            ↑ 跳过了 12-16 和 12-18
```

## 代码修改清单

### 修改的状态

```diff
- const [isFullScreen, setIsFullScreen] = useState(false)
+ const [isChartFullScreen, setIsChartFullScreen] = useState(false)
+ const [isTableFullScreen, setIsTableFullScreen] = useState(false)
```

### 修改的监听器

```diff
  useEffect(() => {
    const handleFullScreenChange = () => {
-     setIsFullScreen(!!document.fullscreenElement)
+     setIsChartFullScreen(!!document.fullscreenElement)
    }
    // ...
  }, [])
```

### 修改的图表配置

```diff
  const chartOptions = {
    plugins: {
      legend: {
        labels: {
-         color: isFullScreen ? '#333333' : undefined,
+         color: isChartFullScreen ? '#333333' : undefined,
        }
      }
    },
    scales: {
      x: {
        ticks: {
-         color: isFullScreen ? '#333333' : undefined,
+         color: isChartFullScreen ? '#333333' : undefined,
+         maxRotation: 45,
+         minRotation: 0,
        }
      }
    }
  }
```

### 修改的容器 class

```diff
  <div 
-   className={`chart-container ${isFullScreen ? 'fullscreen' : ''}`}
+   className={`chart-container ${isChartFullScreen ? 'fullscreen' : ''}`}
  >
```

### 修改的按钮

```diff
  <button
-   onClick={toggleFullScreen}
+   onClick={toggleFullScreen}
-   title={isFullScreen ? '退出全屏' : '全屏显示'}
+   title={isChartFullScreen ? '退出全屏' : '全屏显示'}
  >
-   {isFullScreen ? '🗗' : '⛶'}
+   {isChartFullScreen ? '🗗' : '⛶'}
  </button>
```

### 修改的表格全屏

```diff
  <button 
-   onClick={() => setIsFullScreen(true)}
+   onClick={() => setIsTableFullScreen(true)}
  >
    ⛶
  </button>

- {isFullScreen && (
+ {isTableFullScreen && (
    <div className="fullscreen-overlay">
-     <button onClick={() => setIsFullScreen(false)}>关闭</button>
+     <button onClick={() => setIsTableFullScreen(false)}>关闭</button>
    </div>
  )}
```

## 测试验证

### 测试场景 1：图表全屏

```
1. 点击图表右上角的⛶按钮
2. ✅ 图表全屏显示
3. ✅ X轴日期清晰可见（黑色文字）
4. ✅ 日期标签适当旋转（如果密集）
5. ✅ 背景白色
6. 点击🗗或ESC退出
7. ✅ 恢复正常视图
```

### 测试场景 2：表格全屏

```
1. 点击历史记录的⛶按钮
2. ✅ 弹出表格全屏弹出层
3. ✅ 显示完整的历史记录表格
4. ✅ 不是图表！
5. 点击"✕ 关闭"或遮罩层
6. ✅ 关闭弹出层
```

### 测试场景 3：两个功能独立

```
1. 点击图表放大 → 图表全屏 ✅
2. 退出图表全屏
3. 点击表格放大 → 表格弹出层 ✅
4. 关闭表格弹出层
5. 再次点击图表放大 → 图表全屏 ✅
6. ✅ 两个功能互不影响
```

### 测试场景 4：不同周期的日期显示

```
1. 选择"日"周期
2. 全屏查看
3. ✅ 日期格式：2025-12-22
4. ✅ 可能旋转45度

5. 选择"周"周期
6. ✅ 日期格式：2025-12-22周
7. ✅ 标签更少，可能不旋转

8. 选择"月"周期
9. ✅ 日期格式：2025年12月
10. ✅ 标签更少，不旋转
```

## 修改文件总结

**文件：** `src/pages/StatisticsPage.jsx`

**修改行数：** 约 20 处

**主要修改：**
1. ✅ 添加 `isChartFullScreen` 状态
2. ✅ 添加 `isTableFullScreen` 状态
3. ✅ 更新全屏监听器
4. ✅ 更新图表配置（颜色+旋转）
5. ✅ 更新饼图配置
6. ✅ 更新图表容器 class
7. ✅ 更新图表按钮
8. ✅ 更新图表高度
9. ✅ 更新表格按钮
10. ✅ 更新表格弹出层

## 技术细节

### 状态命名规范

**更清晰的命名：**
```javascript
// ❌ 模糊的命名
const [isFullScreen, setIsFullScreen] = useState(false)

// ✅ 清晰的命名
const [isChartFullScreen, setIsChartFullScreen] = useState(false)
const [isTableFullScreen, setIsTableFullScreen] = useState(false)
```

**命名原则：**
- 明确指出状态的作用域
- 避免一词多义
- 便于代码维护

### Chart.js ticks 配置

**完整的 ticks 配置：**
```javascript
ticks: {
  color: '#333333',           // 文字颜色
  maxRotation: 45,            // 最大旋转角度
  minRotation: 0,             // 最小旋转角度
  autoSkip: true,             // 自动跳过（默认）
  autoSkipPadding: 0,         // 跳过时的间距
  labelOffset: 0,             // 标签偏移
  maxTicksLimit: undefined,   // 最大标签数量
}
```

### Fullscreen API 监听

**为什么要监听？**
```javascript
useEffect(() => {
  const handleFullScreenChange = () => {
    setIsChartFullScreen(!!document.fullscreenElement)
  }
  
  // 监听全屏状态变化
  document.addEventListener('fullscreenchange', handleFullScreenChange)
  
  return () => {
    // 清理监听器
    document.removeEventListener('fullscreenchange', handleFullScreenChange)
  }
}, [])
```

**作用：**
- 用户按 ESC 键退出时，同步更新状态
- 确保 UI 状态与实际全屏状态一致

## 注意事项

### 1. 状态同步

**重要：**
- `isChartFullScreen` 由 Fullscreen API 监听器控制
- 进入/退出全屏都会触发监听器
- 自动同步状态

### 2. 表格全屏的实现

**不同的实现方式：**
- 图表全屏：使用原生 Fullscreen API
- 表格全屏：使用 fixed 定位的弹出层

**为什么不同？**
- 图表需要真正的全屏（横屏锁定）
- 表格只需要遮罩层弹出即可

### 3. X 轴日期格式

**不同周期的格式：**
```javascript
if (chartPeriod === 'day') {
  labelText = formatDate(date)  // 2025-12-22
} else if (chartPeriod === 'week') {
  labelText = `${date.format('YYYY-MM-DD')}周`  // 2025-12-22周
} else if (chartPeriod === 'month') {
  labelText = date.format('YYYY年MM月')  // 2025年12月
}
```

---

## ✅ 问题已修复！

**修复内容：**
1. ✅ 分离了图表和表格的全屏状态
2. ✅ 优化了 X 轴标签旋转配置
3. ✅ 修复了历史记录放大按钮功能

**修改文件：**
- ✅ StatisticsPage.jsx（约 20 处修改）

**测试完成：**
- ✅ 图表全屏：X 轴日期正常显示
- ✅ 表格全屏：显示表格而非图表
- ✅ 两个功能独立工作

---

**🚀 请刷新页面测试！**

1. 点击图表放大按钮 → 应该看到图表全屏，X 轴日期清晰
2. 点击历史记录放大按钮 → 应该看到表格全屏，而不是图表

📊✨

