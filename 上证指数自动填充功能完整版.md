# 📊 上证指数自动填充功能（完整版）

## 功能说明

当用户在记录页面填写数据时，系统会自动检查数据库中是否有当天日期的上证指数数据，如果有则自动填充。

## 触发时机（已优化）

系统会在以下情况自动检查并填充上证指数：

1. ✅ **页面初次加载**
2. ✅ **日期改变**时
3. ✅ **投资类型切换**时（新增）

### 实现代码

```javascript
// 监听日期和投资类型的改变
useEffect(() => {
  loadTodayOverview()
}, [formData.date, formData.investmentType])  // 同时监听两个字段
```

## 使用场景

### 场景1：切换投资类型自动填充

```
初始状态：
- 日期：2025-12-25
- 投资类型：股票
- 上证指数：（空）

切换投资类型 → 基金
  ↓
系统检测 → 2025-12-25 已有上证指数：3917.36
  ↓
自动填充 ✅
```

### 场景2：同一天多次记录

```
第一次记录（上午）：
- 投资类型：股票
- 上证指数：3917.36  ← 手动输入

第二次记录（下午）：
- 选择投资类型：基金
  ↓
- 上证指数：3917.36  ← 自动填充 ✅
```

### 场景3：日期和类型组合切换

```
操作序列：
1. 选择日期：2025-12-25
   → 检查并填充上证指数

2. 切换类型：股票 → 基金
   → 重新检查并填充（确保数据最新）

3. 切换日期：2025-12-25 → 2025-12-26
   → 检查新日期的上证指数

4. 切换类型：基金 → 股票
   → 再次检查当前日期的上证指数
```

## 工作流程

```
用户操作
    ↓
触发条件：
  - 页面加载
  - 日期改变
  - 投资类型改变  ← 新增
    ↓
执行 loadTodayOverview()
    ↓
获取当前日期的所有记录
    ↓
查找有上证指数的记录
    ↓
找到了？
  ├─ Yes → 自动填充 ✅
  └─ No  → 保持空白
```

## 实现细节

### useEffect 监听

```javascript
// 修改前（只监听日期）
useEffect(() => {
  loadTodayOverview()
}, [formData.date])

// 修改后（同时监听日期和投资类型）
useEffect(() => {
  loadTodayOverview()
}, [formData.date, formData.investmentType])
```

### 为什么要监听投资类型？

**原因：**

1. **用户体验一致性**
   - 无论是改日期还是改类型，都应该自动填充

2. **数据准确性**
   - 切换类型时，确保使用的是当前日期的上证指数

3. **减少操作步骤**
   - 用户切换类型后不需要手动重新输入

**示例：**
```
情况1：用户先选日期再选类型
  选择 2025-12-25 → 自动填充 ✅
  切换 股票 → 基金 → 自动填充 ✅

情况2：用户先选类型再选日期
  选择 基金 → （无数据）
  选择 2025-12-25 → 自动填充 ✅
```

## 数据查询逻辑

```javascript
const loadTodayOverview = async () => {
  // 1. 获取所有记录
  const records = await getRecords()
  
  // 2. 获取当前选择的日期
  const currentDate = formData.date || dayjs().format('YYYY-MM-DD')
  
  // 3. 过滤当前日期的记录
  const todayRecords = records.filter(r => r.date === currentDate)
  
  // 4. 查找任意一条有上证指数的记录
  const todayWithShanghaiIndex = todayRecords.find(r => r.shanghaiIndex)
  
  // 5. 自动填充
  if (todayWithShanghaiIndex && todayWithShanghaiIndex.shanghaiIndex) {
    setFormData(prev => ({
      ...prev,
      shanghaiIndex: todayWithShanghaiIndex.shanghaiIndex.toString()
    }))
    console.log('✅ 自动填充上证指数:', todayWithShanghaiIndex.shanghaiIndex)
  }
}
```

## 完整的触发场景

### 1. 页面初次加载

```
用户打开记录页面
  ↓
useEffect 执行
  ↓
loadTodayOverview()
  ↓
检查今日上证指数
  ↓
自动填充（如果有数据）
```

### 2. 日期改变

```
用户选择新日期
  ↓
formData.date 改变
  ↓
useEffect 触发
  ↓
loadTodayOverview()
  ↓
检查新日期的上证指数
  ↓
自动填充（如果有数据）
```

### 3. 投资类型改变（新增）

```
用户点击 股票/基金 按钮
  ↓
formData.investmentType 改变
  ↓
useEffect 触发  ← 新增
  ↓
loadTodayOverview()
  ↓
检查当前日期的上证指数
  ↓
自动填充（如果有数据）
```

## 测试场景

### 测试1：切换类型触发填充

```
步骤：
1. 打开记录页面
2. 日期：今天
3. 类型：股票，上证指数：3917.36
4. 保存

5. 刷新页面
6. 类型：选择基金
   → 上证指数应该自动填充：3917.36 ✅

7. 切换回股票
   → 上证指数保持：3917.36 ✅
```

### 测试2：先切类型再切日期

```
步骤：
1. 打开记录页面
2. 类型：选择基金
   → 上证指数：（空）

3. 日期：选择昨天（假设昨天有数据）
   → 上证指数：自动填充昨天的值 ✅

4. 类型：切换到股票
   → 上证指数：保持昨天的值 ✅
```

### 测试3：多次切换

```
步骤：
1. 类型：股票 → 基金 → 股票
   → 每次切换都会重新检查并填充 ✅

2. 日期：今天 → 明天 → 今天
   → 每次切换都会重新检查并填充 ✅
```

## 优点

### 1. 更好的用户体验

- ✅ 无论如何操作，都能自动填充
- ✅ 减少重复输入
- ✅ 提高录入效率

### 2. 数据一致性

- ✅ 同一天的所有记录使用相同的上证指数
- ✅ 无论股票还是基金，指数都一致

### 3. 灵活性

- ✅ 自动填充的值可以手动修改
- ✅ OCR识别到的值会覆盖自动填充
- ✅ 不会强制使用历史值

## 注意事项

### 1. 性能考虑

```javascript
// useEffect 会在任一依赖项改变时触发
// 但 loadTodayOverview 是异步操作，不会阻塞UI

useEffect(() => {
  loadTodayOverview()  // 异步执行，不影响性能
}, [formData.date, formData.investmentType])
```

### 2. 数据来源

- 取第一条有上证指数的记录
- 不区分股票还是基金类型
- 上证指数是全市场统一的，类型无关

### 3. 覆盖规则

**优先级（从高到低）：**
1. 用户手动修改
2. OCR识别结果
3. 自动填充（最低）

## 控制台日志

### 成功填充

```
✅ 自动填充上证指数: 3917.36
```

### 触发原因

可以通过 React DevTools 查看触发原因：

```
useEffect triggered by:
  - formData.date changed
  - formData.investmentType changed
```

## 代码对比

### 修改前

```javascript
// 只监听日期改变
useEffect(() => {
  loadTodayOverview()
}, [formData.date])

// 问题：切换投资类型时不会自动填充
```

### 修改后

```javascript
// 同时监听日期和投资类型改变
useEffect(() => {
  loadTodayOverview()
}, [formData.date, formData.investmentType])

// 优点：任何相关改变都会触发自动填充
```

## 完整流程图

```
用户操作
    ├─ 打开页面
    ├─ 切换日期
    └─ 切换投资类型  ← 新增
        ↓
    触发 useEffect
        ↓
    执行 loadTodayOverview()
        ↓
    查询数据库
        ↓
    过滤当前日期记录
        ↓
    查找上证指数
        ↓
    自动填充表单
        ↓
    显示给用户
```

---

## 🎉 功能增强完成！

**新增功能：**
- ✅ 切换投资类型时自动填充上证指数

**触发时机：**
1. ✅ 页面加载
2. ✅ 日期改变
3. ✅ 投资类型改变（新增）

**用户体验：**
- ✅ 无论如何操作，都能自动填充
- ✅ 减少重复输入
- ✅ 提高数据一致性

---

**🚀 请刷新页面测试！**

现在切换投资类型时，也会自动填充上证指数了！💪

